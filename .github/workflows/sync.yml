name: Sync metadata from contrib

on:
 workflow_dispatch:
 
permissions:
  contents: write
  pull-requests: write

jobs:
  sync_metadata:
    name: Sync metadata
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
      - name: Checkout new branch
        run: git checkout -b metadata-update-${{ steps.date.outputs.date }}
      - name: Download settings from contrib
        run: |
          cd cfgschema
          go run .
      - name: Download metrics from contrib
        run: |
          ./import_metric_metadata.sh
      - uses: EndBug/add-and-commit@v9 # You can change this to use a specific version.
        with:
          default_author: github_actor
          push: true
          message: 'Metada update ${{ steps.date.outputs.date }}'
      - name: Create pull request
        run: gh pr create -B main -H metadata-update-${{ steps.date.outputs.date }} --title 'Merge metadata-update-${{ steps.date.outputs.date }} into main' --body 'Automatic sync PR to update reference files from contrib'
        env:
          GITHUB_TOKEN: ${{ secrets.PR_TOKEN }}
